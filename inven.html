<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }
        .tab-btn.active {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .tab-btn {
            transition: all 0.3s ease;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out;
        }
        #reader {
            width: 100%;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        .btn-success {
            background: linear-gradient(135deg, #10b981, #047857);
        }
        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        .notification {
            animation: slideDown 0.3s ease;
        }
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <!-- Notification Area -->
    <div id="notification" class="fixed top-0 left-0 right-0 z-50 hidden">
        <div class="notification bg-green-500 text-white p-4 text-center">
            <span id="notification-text"></span>
        </div>
    </div>

    <div id="app" class="h-screen w-screen flex flex-col">
        <!-- Header -->
        <header class="bg-blue-600 text-white shadow-lg p-4 flex items-center justify-between z-20 flex-shrink-0">
            <div class="flex items-center space-x-3">
                <img src="https://static.wixstatic.com/media/311af0_85acadb4f0c246959f774351d0564f08~mv2.png/v1/fill/w_70,h_80,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/Logo-png-Dark-Name_edited.png" 
                     alt="The Honey Shelter Logo" 
                     class="h-10 w-auto">
                <div>
                    <h1 class="text-lg font-bold">The Honey Shelter</h1>
                    <p class="text-xs text-blue-100">Inventory Manager</p>
                </div>
            </div>
            <div class="text-xs text-blue-100">
                📦 Offline Ready
            </div>
        </header>

        <!-- Tab Navigation -->
        <nav class="bg-white shadow-md flex justify-around p-2 flex-shrink-0">
            <button data-tab="sales" class="tab-btn flex-1 py-3 px-4 text-center font-medium rounded-lg mx-1 active">
                💰 Sales
            </button>
            <button data-tab="inventory" class="tab-btn flex-1 py-3 px-4 text-center font-medium rounded-lg mx-1">
                📋 Inventory
            </button>
            <button data-tab="reports" class="tab-btn flex-1 py-3 px-4 text-center font-medium rounded-lg mx-1">
                📊 Reports
            </button>
        </nav>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-4">
            
            <!-- Sales Tab -->
            <div id="sales-tab" class="tab-content">
                <div class="max-w-md mx-auto space-y-6">
                    <!-- Scanner Section -->
                    <div class="card p-6">
                        <h2 class="text-lg font-semibold mb-4 text-center">📱 Record Sale</h2>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Barcode</label>
                                <div class="relative">
                                    <input type="text" id="barcode-input" 
                                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent pr-12" 
                                           placeholder="Scan or enter barcode...">
                                    <button id="scan-btn" class="absolute right-2 top-2 p-2 text-blue-600 hover:bg-blue-50 rounded">
                                        📷
                                    </button>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Quantity</label>
                                <input type="number" id="quantity-input" value="1" min="1" 
                                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            
                            <button id="add-to-sale-btn" class="btn-primary w-full text-white py-3 rounded-lg font-semibold">
                                ➕ Add to Sale
                            </button>
                        </div>
                    </div>

                    <!-- Sales Staging Area -->
                    <div class="card p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-semibold">Sale Items</h3>
                            <button id="clear-sale-staging" class="text-red-500 text-sm hover:text-red-700">Clear All</button>
                        </div>
                        <div id="sale-staging" class="space-y-2 max-h-60 overflow-y-auto mb-4">
                            <p class="text-gray-500 text-center py-4">Add items to complete sale</p>
                        </div>
                        <button id="confirm-sale-btn" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                            ✅ Confirm Sale
                        </button>
                    </div>

                    <!-- Today's Sales Summary -->
                    <div class="card p-4">
                        <h3 class="font-semibold mb-3">Today's Sales</h3>
                        <div id="today-sales" class="space-y-2 max-h-60 overflow-y-auto">
                            <p class="text-gray-500 text-center py-4">No sales recorded yet</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Inventory Tab -->
            <div id="inventory-tab" class="tab-content hidden">
                <div class="max-w-4xl mx-auto space-y-6">
                    <!-- Add Product Section -->
                    <div class="card p-6">
                        <h2 class="text-lg font-semibold mb-4">📦 Add/Update Inventory</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Product Barcode</label>
                                <div class="relative">
                                    <input type="text" id="inv-barcode" 
                                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent pr-12" 
                                           placeholder="Scan or enter barcode...">
                                    <button id="inv-scan-btn" class="absolute right-2 top-2 p-2 text-blue-600 hover:bg-blue-50 rounded">
                                        📷
                                    </button>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Add Quantity</label>
                                <input type="number" id="inv-quantity" value="1" min="1" 
                                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                        </div>
                        
                        <button id="add-to-inventory-staging-btn" class="btn-success w-full md:w-auto text-white py-3 px-6 rounded-lg font-semibold mt-4">
                            ➕ Add to Staging
                        </button>
                    </div>

                    <!-- Inventory Staging Area -->
                    <div class="card p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Inventory Updates</h3>
                            <button id="clear-inventory-staging" class="text-red-500 text-sm hover:text-red-700">Clear All</button>
                        </div>
                        <div id="inventory-staging" class="space-y-2 max-h-60 overflow-y-auto mb-4">
                            <p class="text-gray-500 text-center py-4">Add products to update inventory</p>
                        </div>
                        <button id="confirm-inventory-btn" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                            ✅ Confirm Inventory Updates
                        </button>
                    </div>

                    <!-- Product List -->
                    <div class="card p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Current Inventory</h3>
                            <button id="reset-btn" class="btn-danger text-white py-2 px-4 rounded-lg text-sm">
                                🔄 Reset Session
                            </button>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left">Product</th>
                                        <th class="px-4 py-3 text-left">Barcode</th>
                                        <th class="px-4 py-3 text-right">Stock</th>
                                        <th class="px-4 py-3 text-right">Sold Today</th>
                                        <th class="px-4 py-3 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="inventory-list">
                                    <!-- Products will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports-tab" class="tab-content hidden">
                <div class="max-w-4xl mx-auto space-y-6">
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="card p-6 text-center">
                            <div class="text-2xl mb-2">💰</div>
                            <div class="text-2xl font-bold text-blue-600" id="total-sales">0</div>
                            <div class="text-sm text-gray-600">Total Items Sold</div>
                        </div>
                        <div class="card p-6 text-center">
                            <div class="text-2xl mb-2">📦</div>
                            <div class="text-2xl font-bold text-green-600" id="total-products">0</div>
                            <div class="text-sm text-gray-600">Products in Stock</div>
                        </div>
                        <div class="card p-6 text-center">
                            <div class="text-2xl mb-2">⚠️</div>
                            <div class="text-2xl font-bold text-red-600" id="low-stock">0</div>
                            <div class="text-sm text-gray-600">Low Stock Items</div>
                        </div>
                    </div>

                    <!-- Sales Report -->
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4">📈 Sales Report</h3>
                        <div id="sales-report" class="overflow-x-auto">
                            <!-- Sales report will be populated here -->
                        </div>
                    </div>

                    <!-- Export/Import -->
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4">💾 Data Management</h3>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <button id="export-btn" class="btn-primary text-white py-3 px-6 rounded-lg">
                                📤 Export Data
                            </button>
                            <button id="import-btn" class="btn-primary text-white py-3 px-6 rounded-lg">
                                📥 Import Data
                            </button>
                            <input type="file" id="import-file" class="hidden" accept=".json">
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Scanner Modal -->
    <div id="scanner-modal" class="modal-backdrop fixed inset-0 z-50 flex items-center justify-center opacity-0 pointer-events-none">
        <div class="modal-content bg-white rounded-xl p-6 w-11/12 max-w-md transform scale-95">
            <h2 class="text-lg font-bold text-center mb-4">📷 Scan Barcode</h2>
            <div id="reader"></div>
            <div id="scanner-status" class="text-center text-sm text-gray-600 mt-3"></div>
            <button id="close-scanner" class="w-full mt-4 bg-red-500 text-white py-3 rounded-lg">
                ❌ Cancel
            </button>
        </div>
    </div>

    <!-- Reset Confirmation Modal -->
    <div id="reset-modal" class="modal-backdrop fixed inset-0 z-50 flex items-center justify-center opacity-0 pointer-events-none">
        <div class="modal-content bg-white rounded-xl p-6 w-11/12 max-w-sm transform scale-95">
            <h2 class="text-lg font-bold text-center mb-4">🔄 Reset Session</h2>
            <p class="text-gray-600 mb-6 text-center">This will reset all inventory quantities to zero and clear today's sales. Continue?</p>
            <div class="flex gap-3">
                <button id="cancel-reset" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg">Cancel</button>
                <button id="confirm-reset" class="flex-1 bg-red-500 text-white py-3 rounded-lg">Reset</button>
            </div>
        </div>
    </div>

    <!-- Quick Edit Modal -->
    <div id="quick-edit-modal" class="modal-backdrop fixed inset-0 z-50 flex items-center justify-center opacity-0 pointer-events-none">
        <div class="modal-content bg-white rounded-xl p-6 w-11/12 max-w-sm transform scale-95">
            <h2 class="text-lg font-bold text-center mb-4">✏️ Quick Edit Stock</h2>
            <div class="mb-4">
                <div id="edit-product-info" class="text-center mb-4">
                    <!-- Product info will be displayed here -->
                </div>
                <label class="block text-sm font-medium text-gray-700 mb-2">New Quantity</label>
                <input type="number" id="edit-quantity-input" min="0" 
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-center text-lg">
            </div>
            <div class="flex gap-3">
                <button id="cancel-edit" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg">Cancel</button>
                <button id="save-edit" class="flex-1 bg-blue-600 text-white py-3 rounded-lg">Save</button>
            </div>
        </div>
    </div>

    <script>
        // Initial product data
        const initialProducts = [
            { id: 'prod-01', name: 'Ajjwain', code: '102025052009', variant: '200g', quantity: 0 },
            { id: 'prod-02', name: 'Ajjwain', code: '102025054508', variant: '450g', quantity: 0 },
            { id: 'prod-03', name: 'Corriender', code: '102025112000', variant: '200g', quantity: 0 },
            { id: 'prod-04', name: 'Corriender', code: '102025114509', variant: '450g', quantity: 0 },
            { id: 'prod-05', name: 'Forest Mix', code: '102025022002', variant: '200g', quantity: 0 },
            { id: 'prod-06', name: 'Forest Mix', code: '102025024501', variant: '450g', quantity: 0 },
            { id: 'prod-07', name: 'Gift Box', code: '102025130011', variant: '4 pack', quantity: 0 },
            { id: 'prod-08', name: 'Gift Box', code: '102025140010', variant: '8 pack', quantity: 0 },
            { id: 'prod-09', name: 'Jamun', code: '102025032001', variant: '200g', quantity: 0 },
            { id: 'prod-10', name: 'Jamun', code: '102025034500', variant: '450g', quantity: 0 },
            { id: 'prod-11', name: 'Keshar Dry Fruits', code: '102025122009', variant: '200g', quantity: 0 },
            { id: 'prod-12', name: 'Keshar Dry Fruits', code: '102025124508', variant: '450g', quantity: 0 },
            { id: 'prod-13', name: 'Litchi', code: '102025102001', variant: '200g', quantity: 0 },
            { id: 'prod-14', name: 'Litchi', code: '102025104500', variant: '450g', quantity: 0 },
            { id: 'prod-15', name: 'Moringa', code: '102025062008', variant: '200g', quantity: 0 },
            { id: 'prod-16', name: 'Moringa', code: '102025064507', variant: '450g', quantity: 0 },
            { id: 'prod-17', name: 'Multiflora', code: '102025012003', variant: '200g', quantity: 0 },
            { id: 'prod-18', name: 'Multiflora', code: '102025014502', variant: '400g', quantity: 0 },
            { id: 'prod-19', name: 'Neem', code: '102025092005', variant: '200g', quantity: 0 },
            { id: 'prod-20', name: 'Neem', code: '102025094504', variant: '450g', quantity: 0 },
            { id: 'prod-21', name: 'Saunf', code: '102025072007', variant: '200g', quantity: 0 },
            { id: 'prod-22', name: 'Saunf', code: '102025074506', variant: '450g', quantity: 0 },
            { id: 'prod-23', name: 'Sunflower', code: '102025082006', variant: '200g', quantity: 0 },
            { id: 'prod-24', name: 'Sunflower', code: '102025084505', variant: '450g', quantity: 0 },
            { id: 'prod-25', name: 'Tulsi', code: '102025042000', variant: '200g', quantity: 0 },
            { id: 'prod-26', name: 'Tulsi', code: '102025044509', variant: '450g', quantity: 0 }
        ];

        // App state
        let products = [];
        let sales = [];
        let html5QrCode = null;
        let currentScanner = null; // Track which input is being scanned for
        let saleStaging = []; // Staging area for sales
        let inventoryStaging = []; // Staging area for inventory updates
        let editingProductId = null; // Track which product is being edited

        // Load data from localStorage
        function loadData() {
            const savedProducts = localStorage.getItem('inventory_products');
            const savedSales = localStorage.getItem('inventory_sales');
            
            products = savedProducts ? JSON.parse(savedProducts) : [...initialProducts];
            sales = savedSales ? JSON.parse(savedSales) : [];
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('inventory_products', JSON.stringify(products));
            localStorage.setItem('inventory_sales', JSON.stringify(sales));
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const text = document.getElementById('notification-text');
            
            text.textContent = message;
            notification.className = `fixed top-0 left-0 right-0 z-50`;
            
            if (type === 'error') {
                notification.querySelector('.notification').className = 'notification bg-red-500 text-white p-4 text-center';
            } else {
                notification.querySelector('.notification').className = 'notification bg-green-500 text-white p-4 text-center';
            }
            
            notification.classList.remove('hidden');
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }

        // Tab switching
        function initTabs() {
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabName = btn.dataset.tab;
                    
                    // Update active tab
                    tabBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // Show/hide content
                    tabContents.forEach(content => {
                        if (content.id === `${tabName}-tab`) {
                            content.classList.remove('hidden');
                            if (tabName === 'reports') {
                                updateReports();
                            }
                        } else {
                            content.classList.add('hidden');
                        }
                    });
                });
            });
        }

        // Scanner functionality
        function initScanner() {
            html5QrCode = new Html5Qrcode("reader");
            
            // Sales scanner
            document.getElementById('scan-btn').addEventListener('click', () => {
                currentScanner = 'sales';
                openScanner();
            });
            
            // Inventory scanner
            document.getElementById('inv-scan-btn').addEventListener('click', () => {
                currentScanner = 'inventory';
                openScanner();
            });
            
            // Close scanner
            document.getElementById('close-scanner').addEventListener('click', closeScanner);
        }

        function openScanner() {
            const modal = document.getElementById('scanner-modal');
            const status = document.getElementById('scanner-status');
            
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.querySelector('.modal-content').classList.remove('scale-95');
            
            status.textContent = 'Starting camera...';
            
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 150 } },
                (decodedText) => {
                    if (currentScanner === 'sales') {
                        document.getElementById('barcode-input').value = decodedText;
                    } else {
                        document.getElementById('inv-barcode').value = decodedText;
                    }
                    closeScanner();
                    if (navigator.vibrate) navigator.vibrate(100);
                },
                () => {} // Error callback (ignore)
            ).catch(err => {
                status.textContent = 'Camera access denied or not available';
            });
        }

        function closeScanner() {
            const modal = document.getElementById('scanner-modal');
            
            if (html5QrCode.isScanning) {
                html5QrCode.stop().then(() => {
                    modal.classList.add('opacity-0', 'pointer-events-none');
                    modal.querySelector('.modal-content').classList.add('scale-95');
                });
            } else {
                modal.classList.add('opacity-0', 'pointer-events-none');
                modal.querySelector('.modal-content').classList.add('scale-95');
            }
        }

        // Sales functionality
        function initSales() {
            document.getElementById('add-to-sale-btn').addEventListener('click', addToSaleStaging);
            document.getElementById('barcode-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addToSaleStaging();
            });
            document.getElementById('confirm-sale-btn').addEventListener('click', confirmSale);
            document.getElementById('clear-sale-staging').addEventListener('click', clearSaleStaging);
        }

        function addToSaleStaging() {
            const barcode = document.getElementById('barcode-input').value.trim();
            const quantity = parseInt(document.getElementById('quantity-input').value);
            
            if (!barcode || quantity <= 0) {
                showNotification('Please enter a valid barcode and quantity', 'error');
                return;
            }
            
            const product = products.find(p => p.code === barcode);
            if (!product) {
                showNotification('Product not found', 'error');
                return;
            }
            
            // Check if product already in staging
            const existingIndex = saleStaging.findIndex(item => item.productId === product.id);
            if (existingIndex > -1) {
                saleStaging[existingIndex].quantity += quantity;
            } else {
                saleStaging.push({
                    productId: product.id,
                    productName: product.name,
                    productVariant: product.variant,
                    quantity: quantity,
                    maxQuantity: product.quantity
                });
            }
            
            updateSaleStaging();
            showNotification(`Added ${quantity}x ${product.name} to sale`);
            
            // Clear form
            document.getElementById('barcode-input').value = '';
            document.getElementById('quantity-input').value = '1';
        }

        function updateSaleStaging() {
            const container = document.getElementById('sale-staging');
            const confirmBtn = document.getElementById('confirm-sale-btn');
            
            if (saleStaging.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Add items to complete sale</p>';
                confirmBtn.disabled = true;
                return;
            }
            
            confirmBtn.disabled = false;
            
            container.innerHTML = saleStaging.map((item, index) => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex-1">
                        <div class="font-medium">${item.productName}</div>
                        <div class="text-sm text-gray-500">${item.productVariant} (Available: ${item.maxQuantity})</div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="adjustSaleQuantity(${index}, -1)" class="w-8 h-8 bg-red-500 text-white rounded-full text-sm hover:bg-red-600">-</button>
                        <span class="font-semibold w-8 text-center">${item.quantity}</span>
                        <button onclick="adjustSaleQuantity(${index}, 1)" class="w-8 h-8 bg-green-500 text-white rounded-full text-sm hover:bg-green-600">+</button>
                        <button onclick="removeSaleItem(${index})" class="w-8 h-8 bg-gray-500 text-white rounded-full text-sm hover:bg-gray-600">×</button>
                    </div>
                </div>
            `).join('');
        }

        function adjustSaleQuantity(index, change) {
            if (index >= 0 && index < saleStaging.length) {
                const newQuantity = saleStaging[index].quantity + change;
                if (newQuantity > 0 && newQuantity <= saleStaging[index].maxQuantity) {
                    saleStaging[index].quantity = newQuantity;
                    updateSaleStaging();
                } else if (newQuantity <= 0) {
                    removeSaleItem(index);
                } else {
                    showNotification('Insufficient stock available', 'error');
                }
            }
        }

        function removeSaleItem(index) {
            if (index >= 0 && index < saleStaging.length) {
                saleStaging.splice(index, 1);
                updateSaleStaging();
            }
        }

        function clearSaleStaging() {
            saleStaging = [];
            updateSaleStaging();
        }

        function confirmSale() {
            if (saleStaging.length === 0) return;
            
            let hasError = false;
            
            // Validate all items have sufficient stock
            for (const item of saleStaging) {
                const product = products.find(p => p.id === item.productId);
                if (!product || product.quantity < item.quantity) {
                    showNotification(`Insufficient stock for ${item.productName}`, 'error');
                    hasError = true;
                    break;
                }
            }
            
            if (hasError) return;
            
            // Process the sale
            saleStaging.forEach(item => {
                const product = products.find(p => p.id === item.productId);
                if (product) {
                    product.quantity -= item.quantity;
                    
                    sales.push({
                        id: Date.now() + Math.random(),
                        productId: product.id,
                        productName: product.name,
                        productVariant: product.variant,
                        quantity: item.quantity,
                        timestamp: new Date().toISOString()
                    });
                }
            });
            
            saveData();
            updateInventoryDisplay();
            updateTodaysSales();
            clearSaleStaging();
            
            showNotification('Sale completed successfully!');
        }

        function recordSale() {
            const barcode = document.getElementById('barcode-input').value.trim();
            const quantity = parseInt(document.getElementById('quantity-input').value);
            
            if (!barcode || quantity <= 0) {
                showNotification('Please enter a valid barcode and quantity', 'error');
                return;
            }
            
            const product = products.find(p => p.code === barcode);
            if (!product) {
                showNotification('Product not found', 'error');
                return;
            }
            
            if (product.quantity < quantity) {
                showNotification('Insufficient stock', 'error');
                return;
            }
            
            // Update stock
            product.quantity -= quantity;
            
            // Record sale
            sales.push({
                id: Date.now(),
                productId: product.id,
                productName: product.name,
                productVariant: product.variant,
                quantity: quantity,
                timestamp: new Date().toISOString()
            });
            
            saveData();
            updateInventoryDisplay();
            updateTodaysSales();
            
            showNotification(`Sold ${quantity}x ${product.name} (${product.variant})`);
            
            // Clear form
            document.getElementById('barcode-input').value = '';
            document.getElementById('quantity-input').value = '1';
        }

        function updateTodaysSales() {
            const container = document.getElementById('today-sales');
            const today = new Date().toDateString();
            const todaySales = sales.filter(s => new Date(s.timestamp).toDateString() === today);
            
            if (todaySales.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No sales recorded yet</p>';
                return;
            }
            
            container.innerHTML = todaySales.slice(-10).reverse().map(sale => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <div>
                        <div class="font-medium">${sale.productName}</div>
                        <div class="text-sm text-gray-500">${sale.productVariant}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-semibold">${sale.quantity}</div>
                        <div class="text-xs text-gray-500">${new Date(sale.timestamp).toLocaleTimeString()}</div>
                    </div>
                </div>
            `).join('');
        }

        // Inventory functionality
        function initInventory() {
            document.getElementById('add-to-inventory-staging-btn').addEventListener('click', addToInventoryStaging);
            document.getElementById('inv-barcode').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addToInventoryStaging();
            });
            document.getElementById('confirm-inventory-btn').addEventListener('click', confirmInventoryUpdates);
            document.getElementById('clear-inventory-staging').addEventListener('click', clearInventoryStaging);
            document.getElementById('reset-btn').addEventListener('click', () => {
                document.getElementById('reset-modal').classList.remove('opacity-0', 'pointer-events-none');
                document.getElementById('reset-modal').querySelector('.modal-content').classList.remove('scale-95');
            });
            
            // Reset modal handlers
            document.getElementById('cancel-reset').addEventListener('click', closeResetModal);
            document.getElementById('confirm-reset').addEventListener('click', resetInventory);
            
            // Quick edit modal handlers
            document.getElementById('cancel-edit').addEventListener('click', closeQuickEditModal);
            document.getElementById('save-edit').addEventListener('click', saveQuickEdit);
            document.getElementById('edit-quantity-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') saveQuickEdit();
            });
        }

        function addToInventoryStaging() {
            const barcode = document.getElementById('inv-barcode').value.trim();
            const quantity = parseInt(document.getElementById('inv-quantity').value);
            
            if (!barcode || quantity <= 0) {
                showNotification('Please enter a valid barcode and quantity', 'error');
                return;
            }
            
            const product = products.find(p => p.code === barcode);
            if (!product) {
                showNotification('Product not found', 'error');
                return;
            }
            
            // Check if product already in staging
            const existingIndex = inventoryStaging.findIndex(item => item.productId === product.id);
            if (existingIndex > -1) {
                inventoryStaging[existingIndex].quantity += quantity;
            } else {
                inventoryStaging.push({
                    productId: product.id,
                    productName: product.name,
                    productVariant: product.variant,
                    quantity: quantity
                });
            }
            
            updateInventoryStaging();
            showNotification(`Added ${quantity}x ${product.name} to inventory staging`);
            
            // Clear form
            document.getElementById('inv-barcode').value = '';
            document.getElementById('inv-quantity').value = '1';
        }

        function updateInventoryStaging() {
            const container = document.getElementById('inventory-staging');
            const confirmBtn = document.getElementById('confirm-inventory-btn');
            
            if (inventoryStaging.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Add products to update inventory</p>';
                confirmBtn.disabled = true;
                return;
            }
            
            confirmBtn.disabled = false;
            
            container.innerHTML = inventoryStaging.map((item, index) => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex-1">
                        <div class="font-medium">${item.productName}</div>
                        <div class="text-sm text-gray-500">${item.productVariant}</div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="adjustInventoryQuantity(${index}, -1)" class="w-8 h-8 bg-red-500 text-white rounded-full text-sm hover:bg-red-600">-</button>
                        <span class="font-semibold w-12 text-center">+${item.quantity}</span>
                        <button onclick="adjustInventoryQuantity(${index}, 1)" class="w-8 h-8 bg-green-500 text-white rounded-full text-sm hover:bg-green-600">+</button>
                        <button onclick="removeInventoryItem(${index})" class="w-8 h-8 bg-gray-500 text-white rounded-full text-sm hover:bg-gray-600">×</button>
                    </div>
                </div>
            `).join('');
        }

        function adjustInventoryQuantity(index, change) {
            if (index >= 0 && index < inventoryStaging.length) {
                const newQuantity = inventoryStaging[index].quantity + change;
                if (newQuantity > 0) {
                    inventoryStaging[index].quantity = newQuantity;
                    updateInventoryStaging();
                } else {
                    removeInventoryItem(index);
                }
            }
        }

        function removeInventoryItem(index) {
            if (index >= 0 && index < inventoryStaging.length) {
                inventoryStaging.splice(index, 1);
                updateInventoryStaging();
            }
        }

        function clearInventoryStaging() {
            inventoryStaging = [];
            updateInventoryStaging();
        }

        function confirmInventoryUpdates() {
            if (inventoryStaging.length === 0) return;
            
            // Process the inventory updates
            inventoryStaging.forEach(item => {
                const product = products.find(p => p.id === item.productId);
                if (product) {
                    product.quantity += item.quantity;
                }
            });
            
            saveData();
            updateInventoryDisplay();
            clearInventoryStaging();
            
            showNotification('Inventory updated successfully!');
        }

        function addStock() {
            const barcode = document.getElementById('inv-barcode').value.trim();
            const quantity = parseInt(document.getElementById('inv-quantity').value);
            
            if (!barcode || quantity <= 0) {
                showNotification('Please enter a valid barcode and quantity', 'error');
                return;
            }
            
            const product = products.find(p => p.code === barcode);
            if (!product) {
                showNotification('Product not found', 'error');
                return;
            }
            
            product.quantity += quantity;
            saveData();
            updateInventoryDisplay();
            
            showNotification(`Added ${quantity}x ${product.name} (${product.variant}) to inventory`);
            
            // Clear form
            document.getElementById('inv-barcode').value = '';
            document.getElementById('inv-quantity').value = '1';
        }

        function updateInventoryDisplay() {
            const tbody = document.getElementById('inventory-list');
            
            tbody.innerHTML = products.map(product => {
                const soldToday = sales
                    .filter(s => s.productId === product.id && 
                            new Date(s.timestamp).toDateString() === new Date().toDateString())
                    .reduce((sum, s) => sum + s.quantity, 0);
                
                return `
                    <tr class="${product.quantity <= 5 ? 'bg-red-50' : 'bg-white'} border-b">
                        <td class="px-4 py-3">
                            <div class="font-medium">${product.name}</div>
                            <div class="text-sm text-gray-500">${product.variant}</div>
                        </td>
                        <td class="px-4 py-3 font-mono text-sm">${product.code}</td>
                        <td class="px-4 py-3 text-right font-semibold ${product.quantity <= 5 ? 'text-red-600' : 'text-gray-900'}">
                            ${product.quantity}
                        </td>
                        <td class="px-4 py-3 text-right text-blue-600 font-medium">${soldToday}</td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="openQuickEdit('${product.id}')" class="bg-blue-500 text-white px-3 py-1 rounded text-xs hover:bg-blue-600">
                                ✏️ Edit
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function closeResetModal() {
            const modal = document.getElementById('reset-modal');
            modal.classList.add('opacity-0', 'pointer-events-none');
            modal.querySelector('.modal-content').classList.add('scale-95');
        }

        function openQuickEdit(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            editingProductId = productId;
            
            // Update modal content
            document.getElementById('edit-product-info').innerHTML = `
                <div class="font-medium text-lg">${product.name}</div>
                <div class="text-sm text-gray-500">${product.variant}</div>
                <div class="text-xs text-gray-400 mt-1">Current Stock: ${product.quantity}</div>
            `;
            
            document.getElementById('edit-quantity-input').value = product.quantity;
            
            // Show modal
            const modal = document.getElementById('quick-edit-modal');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.querySelector('.modal-content').classList.remove('scale-95');
            
            // Focus and select the input
            setTimeout(() => {
                const input = document.getElementById('edit-quantity-input');
                input.focus();
                input.select();
            }, 100);
        }

        function closeQuickEditModal() {
            const modal = document.getElementById('quick-edit-modal');
            modal.classList.add('opacity-0', 'pointer-events-none');
            modal.querySelector('.modal-content').classList.add('scale-95');
            editingProductId = null;
        }

        function saveQuickEdit() {
            if (!editingProductId) return;
            
            const newQuantity = parseInt(document.getElementById('edit-quantity-input').value);
            if (isNaN(newQuantity) || newQuantity < 0) {
                showNotification('Please enter a valid quantity', 'error');
                return;
            }
            
            const product = products.find(p => p.id === editingProductId);
            if (product) {
                const oldQuantity = product.quantity;
                product.quantity = newQuantity;
                saveData();
                updateInventoryDisplay();
                closeQuickEditModal();
                
                showNotification(`Updated ${product.name} stock from ${oldQuantity} to ${newQuantity}`);
            }
        }

        function resetInventory() {
            products.forEach(p => p.quantity = 0);
            sales.length = 0;
            saleStaging = [];
            inventoryStaging = [];
            saveData();
            updateInventoryDisplay();
            updateTodaysSales();
            updateSaleStaging();
            updateInventoryStaging();
            updateReports();
            closeResetModal();
            showNotification('Inventory reset successfully');
        }

        // Reports functionality
        function updateReports() {
            const totalSales = sales.reduce((sum, s) => sum + s.quantity, 0);
            const totalProducts = products.filter(p => p.quantity > 0).length;
            const lowStock = products.filter(p => p.quantity <= 5 && p.quantity > 0).length;
            
            document.getElementById('total-sales').textContent = totalSales;
            document.getElementById('total-products').textContent = totalProducts;
            document.getElementById('low-stock').textContent = lowStock;
            
            updateSalesReport();
        }

        function updateSalesReport() {
            const container = document.getElementById('sales-report');
            
            if (sales.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No sales data available</p>';
                return;
            }
            
            const sortedSales = [...sales].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            container.innerHTML = `
                <table class="w-full text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left">Date/Time</th>
                            <th class="px-4 py-3 text-left">Product</th>
                            <th class="px-4 py-3 text-right">Quantity</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedSales.slice(0, 100).map(sale => `
                            <tr class="border-b">
                                <td class="px-4 py-3 text-gray-600">
                                    ${new Date(sale.timestamp).toLocaleDateString()}<br>
                                    <span class="text-xs">${new Date(sale.timestamp).toLocaleTimeString()}</span>
                                </td>
                                <td class="px-4 py-3">
                                    <div class="font-medium">${sale.productName}</div>
                                    <div class="text-xs text-gray-500">${sale.productVariant}</div>
                                </td>
                                <td class="px-4 py-3 text-right font-semibold">${sale.quantity}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Data export/import
        function initDataManagement() {
            document.getElementById('export-btn').addEventListener('click', exportData);
            document.getElementById('import-btn').addEventListener('click', () => {
                document.getElementById('import-file').click();
            });
            document.getElementById('import-file').addEventListener('change', importData);
        }

        function exportData() {
            const data = {
                products: products,
                sales: sales,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `inventory-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('Data exported successfully');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.products && data.sales) {
                        products = data.products;
                        sales = data.sales;
                        saveData();
                        updateInventoryDisplay();
                        updateTodaysSales();
                        updateReports();
                        showNotification('Data imported successfully');
                    } else {
                        showNotification('Invalid file format', 'error');
                    }
                } catch (error) {
                    showNotification('Error reading file', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset file input
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            initTabs();
            initScanner();
            initSales();
            initInventory();
            initDataManagement();
            
            updateInventoryDisplay();
            updateTodaysSales();
            updateReports();
            
            // Make functions available globally for onclick handlers
            window.adjustSaleQuantity = adjustSaleQuantity;
            window.removeSaleItem = removeSaleItem;
            window.adjustInventoryQuantity = adjustInventoryQuantity;
            window.removeInventoryItem = removeInventoryItem;
            window.openQuickEdit = openQuickEdit;
        });
    </script>
</body>
</html>

